<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ìœ íŠœë¸Œ ì˜ìƒ ë¶„ì„í”„ë¡œê·¸ë¨</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2d;
      --panel2:#101f36;
      --text:#e9f0ff;
      --muted:#a9b7d1;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.14);
      --accent:#7aa9ff;
      --good:#1ed760;
      --warn:#ffcc00;
      --bad:#ff4d4d;
      --chip:#152747;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, "Malgun Gothic", Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(122,169,255,.18), transparent 60%),
        radial-gradient(1000px 600px at 90% 20%, rgba(255,204,0,.08), transparent 55%),
        radial-gradient(900px 700px at 70% 100%, rgba(30,215,96,.10), transparent 60%),
        var(--bg);
    }

    /* ë ˆì´ì•„ì›ƒ */
    .app{
      display:flex;
      height:100%;
      min-height:100vh;
    }
    .sidebar{
      width: 360px;
      min-width: 320px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 40%), var(--panel);
      border-right: 1px solid var(--line);
      padding: 18px 16px;
      overflow:auto;
    }
    .main{
      flex:1;
      padding: 18px 18px 28px 18px;
      overflow:auto;
    }

    /* íƒ€ì´í¬ */
    h1{
      margin:0 0 6px 0;
      font-size: 18px;
      letter-spacing: -0.2px;
    }
    .subtitle{
      font-size: 12px;
      color: var(--muted);
      line-height:1.35;
      margin-bottom: 14px;
    }
    .section-title{
      font-size: 13px;
      color: rgba(233,240,255,.92);
      margin: 16px 0 10px;
      font-weight: 650;
      letter-spacing: -0.2px;
    }
    .hint{
      color: var(--muted);
      font-size: 12px;
      line-height:1.35;
      margin-top:6px;
    }

    /* ì¹´ë“œ/íŒ¨ë„ */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 60%), var(--panel2);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .sidebar .card{ box-shadow:none; background: rgba(255,255,255,.03); }

    /* ì…ë ¥ */
    label{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin: 10px 0 6px;
    }
    input[type="text"], input[type="date"], select{
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
    }
    input::placeholder{ color: rgba(169,183,209,.65); }
    select option{ background:#0b1220; }

    .row{
      display:flex;
      gap:10px;
    }
    .row > *{ flex:1; }

    /* ë²„íŠ¼ */
    .btn{
      width:100%;
      border: 1px solid rgba(122,169,255,.35);
      background: linear-gradient(180deg, rgba(122,169,255,.22), rgba(122,169,255,.10));
      color: var(--text);
      border-radius: 12px;
      padding: 11px 12px;
      cursor:pointer;
      font-weight: 650;
      letter-spacing: -0.2px;
      transition: transform .06s ease, filter .15s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ filter: brightness(1.1); border-color: rgba(122,169,255,.55); }

    .btn.secondary{
      background: rgba(255,255,255,.05);
      border-color: var(--line2);
      font-weight: 600;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,77,77,.22), rgba(255,77,77,.12));
      border-color: rgba(255,77,77,.45);
    }
    .btn.small{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      width:auto;
    }

    /* ìƒë‹¨ ëŒ€ì‹œë³´ë“œ */
    .dashboard{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin-bottom: 14px;
    }
    .stat{
      grid-column: span 3;
      padding: 14px 14px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.045), transparent 65%), rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      min-height: 94px;
    }
    .stat .k{
      font-size:12px;
      color: var(--muted);
      margin-bottom:8px;
    }
    .stat .v{
      font-size: 22px;
      font-weight: 820;
      letter-spacing: -0.4px;
      line-height: 1.1;
    }
    .stat .s{
      font-size: 12px;
      color: rgba(233,240,255,.78);
      margin-top: 6px;
      line-height:1.3;
    }
    .stat.wide{ grid-column: span 6; }
    .stat.full{ grid-column: span 12; }

    .taglist{
      display:flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(122,169,255,.10);
      border: 1px solid rgba(122,169,255,.22);
      color: rgba(233,240,255,.95);
      font-size: 12px;
      cursor:pointer;
      transition: filter .15s ease, transform .06s ease;
    }
    .chip:hover{ filter: brightness(1.15); }
    .chip:active{ transform: translateY(1px); }
    .chip .count{
      font-family: var(--mono);
      color: rgba(233,240,255,.78);
      font-size: 11px;
    }

    /* ì—°ê´€ í‚¤ì›Œë“œ */
    .kw-wrap{
      margin: 12px 0 14px;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .kw-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .kw-title{
      font-size: 13px;
      font-weight: 750;
      letter-spacing:-0.2px;
    }
    .kw-sub{
      font-size:12px;
      color: var(--muted);
    }

    /* í…Œì´ë¸” */
    .table-card{
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .table-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 80%);
    }
    .table-toolbar .left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      font-size:12px;
      color: rgba(233,240,255,.9);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.03);
    }
    .table-wrap{
      overflow:auto;
      max-width: 100%;
    }
    table{
      width: 1400px; /* í…Œì´ë¸”ì´ ì˜ë¦¬ì§€ ì•Šê²Œ ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
      color: rgba(233,240,255,.92);
    }
    th{
      position: sticky;
      top: 0;
      background: rgba(16,31,54,.92);
      backdrop-filter: blur(10px);
      z-index: 2;
      text-align:left;
      font-size: 12px;
      color: rgba(233,240,255,.95);
      border-bottom: 1px solid rgba(255,255,255,.14);
      cursor: pointer;
      user-select:none;
      white-space:nowrap;
    }
    th .sort{
      margin-left:6px;
      font-size: 11px;
      color: rgba(233,240,255,.6);
    }
    tr:hover td{ background: rgba(255,255,255,.03); }
    .thumb{
      width: 96px;
      height: 54px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid rgba(255,255,255,.14);
      cursor: pointer;
    }
    a{
      color: rgba(122,169,255,.95);
      text-decoration: none;
    }
    a:hover{ text-decoration: underline; }
    .muted{ color: var(--muted); }
    .mono{ font-family: var(--mono); }

    /* íƒœê·¸ ì…€ */
    .tags-cell{
      max-width: 260px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      line-height: 1.4;
    }

    /* ì„±ê³¼ ìƒ‰ìƒ */
    .perf{
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:10px; height:10px; border-radius: 999px;
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }

    /* ìƒíƒœ/ì•Œë¦¼ */
    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 520px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line2);
      background: rgba(15,26,45,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      color: rgba(233,240,255,.95);
      font-size: 13px;
      line-height: 1.35;
      display:none;
      z-index: 10;
    }
    .toast.show{ display:block; }
    .toast .t{ font-weight: 800; margin-bottom: 2px; }
    .toast .d{ color: rgba(233,240,255,.82); }
    .toast .x{
      position:absolute;
      top:10px; right:10px;
      width:26px; height:26px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: rgba(233,240,255,.8);
      cursor:pointer;
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 980px){
      .app{ flex-direction: column; }
      .sidebar{ width:100%; min-width: unset; border-right:none; border-bottom: 1px solid var(--line); }
      .dashboard{ grid-template-columns: repeat(6, 1fr); }
      .stat{ grid-column: span 3; }
      .stat.wide{ grid-column: span 6; }
      table{ width: 1200px; }
    }
    @media (max-width: 540px){
      .dashboard{ grid-template-columns: repeat(2, 1fr); }
      .stat{ grid-column: span 2; }
      .stat.wide{ grid-column: span 2; }
      table{ width: 1100px; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
      <h1>ìœ íŠœë¸Œ ì˜ìƒ ë¶„ì„ê¸°</h1>
      <div class="subtitle">
        ìœ íŠœë¸Œ APIë¡œ ì œëª© ê¸°ë°˜ ê²€ìƒ‰ â†’ ì¡°íšŒìˆ˜/ì¢‹ì•„ìš”/êµ¬ë…ì/VPH/íƒœê·¸/ëŒ€ì‹œë³´ë“œ ìš”ì•½ê¹Œì§€ í•œ ë²ˆì—.<br/>
        <span class="muted">API í‚¤ëŠ” ì´ í™”ë©´ì—ì„œ ì…ë ¥Â·ì €ì¥ë©ë‹ˆë‹¤(ì½”ë“œì— ì €ì¥í•˜ì§€ ì•ŠìŒ).</span>
      </div>

      <div class="card" style="padding:14px;border-radius:18px;">
        <div class="section-title" style="margin-top:0;">ìœ íŠœë¸Œ API í‚¤</div>
        <label for="apiKey">API í‚¤ ì…ë ¥</label>
        <input id="apiKey" type="text" placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" autocomplete="off"/>
        <div class="row" style="margin-top:10px;">
          <button class="btn" id="saveKeyBtn">í‚¤ ì €ì¥</button>
          <button class="btn secondary" id="clearKeyBtn">í‚¤ ì‚­ì œ</button>
        </div>
        <div class="hint">í‚¤ëŠ” ë¸Œë¼ìš°ì €ì˜ localStorageì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>

        <div class="section-title">ê²€ìƒ‰</div>
        <label for="query">ê²€ìƒ‰ì–´(ì œëª© ê¸°ì¤€)</label>
        <input id="query" type="text" placeholder="ì˜ˆ: ê³¨í”„ ë“œë¼ì´ë²„ ë¹„ê±°ë¦¬ / ë¶€ë™ì‚° ê²½ë§¤ / ì‡¼ì¸  í¸ì§‘" autocomplete="off"/>
        <label for="maxResults">ê²€ìƒ‰ ê°œìˆ˜</label>
        <select id="maxResults">
          <option value="10">10ê°œ</option>
          <option value="25" selected>25ê°œ</option>
          <option value="50">50ê°œ</option>
        </select>

        <div class="row" style="margin-top:12px;">
          <button class="btn" id="searchBtn">ê²€ìƒ‰ ì‹¤í–‰</button>
          <button class="btn secondary" id="resetBtn">ì´ˆê¸°í™”</button>
        </div>

        <div class="section-title">í•„í„°</div>
        <label for="typeFilter">ì˜ìƒ ìœ í˜•</label>
        <select id="typeFilter">
          <option value="all" selected>ì „ì²´</option>
          <option value="short">ìˆí¼(1ë¶„ ë¯¸ë§Œ)</option>
          <option value="long">ë¡±í¼(20ë¶„ ì´ìƒ)</option>
        </select>

        <label for="datePreset">ì—…ë¡œë“œ ê¸°ê°„</label>
        <select id="datePreset">
          <option value="all" selected>ì „ì²´</option>
          <option value="7">ìµœê·¼ 7ì¼</option>
          <option value="30">ìµœê·¼ 30ì¼</option>
          <option value="90">ìµœê·¼ 90ì¼</option>
          <option value="custom">ì§ì ‘ ì„ íƒ</option>
        </select>

        <div class="row" id="customDateRow" style="display:none;margin-top:8px;">
          <div>
            <label for="dateFrom">ì‹œì‘</label>
            <input id="dateFrom" type="date"/>
          </div>
          <div>
            <label for="dateTo">ë</label>
            <input id="dateTo" type="date"/>
          </div>
        </div>

        <label for="impactFilter">ì˜í–¥ë ¥(êµ¬ë…ì ëŒ€ë¹„ ì¡°íšŒìˆ˜)</label>
        <select id="impactFilter">
          <option value="all" selected>ì „ì²´</option>
          <option value="5">ğŸ”´ ë§¤ìš° ë†’ìŒ</option>
          <option value="4">ğŸŸ  ë†’ìŒ</option>
          <option value="3">ğŸŸ¡ ë³´í†µ</option>
          <option value="2">ğŸŸ¢ ë‚®ìŒ</option>
          <option value="1">ğŸ”µ ë§¤ìš° ë‚®ìŒ</option>
        </select>

        <div class="row" style="margin-top:12px;">
          <button class="btn secondary" id="applyFilterBtn">í•„í„° ì ìš©</button>
          <button class="btn secondary" id="csvBtn">CSV ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <div class="hint">
          â€» ì²« í™”ë©´ì€ ì¡°íšŒìˆ˜ ë†’ì€ ìˆœì„œë¡œ ì •ë ¬ë©ë‹ˆë‹¤.<br/>
          â€» ì œëª© í´ë¦­: ì˜ìƒ ë°”ë¡œ ë³´ê¸° / ì¸ë„¤ì¼ í´ë¦­: ë‹¤ìš´ë¡œë“œ ì‹œë„
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="card" style="padding:14px;border-radius:18px;">
        <div class="section-title" style="margin-top:0;">ì‚¬ìš© íŒ</div>
        <div class="hint">
          1) ê²€ìƒ‰ ì‹¤í–‰ í›„ ìƒë‹¨ ëŒ€ì‹œë³´ë“œë¡œ í‰ê·  ì„±ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.<br/>
          2) â€œíƒœê·¸ TOP 5â€ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ íƒœê·¸ë¡œ ì¦‰ì‹œ ì¬ê²€ìƒ‰í•©ë‹ˆë‹¤.<br/>
          3) â€œì—°ê´€ í‚¤ì›Œë“œâ€ë¥¼ í´ë¦­í•˜ë©´ ê¸°íš í›„ë³´ë¥¼ ë¹ ë¥´ê²Œ í™•ì¥í•  ìˆ˜ ìˆì–´ìš”.
        </div>
      </div>
    </aside>

    <!-- ìš°ì¸¡ ë©”ì¸ -->
    <main class="main">
      <!-- ëŒ€ì‹œë³´ë“œ -->
      <div class="dashboard" id="dashboard">
        <div class="stat">
          <div class="k">í‰ê·  ì¡°íšŒìˆ˜</div>
          <div class="v" id="avgViews">-</div>
          <div class="s">í˜„ì¬ ê²°ê³¼ ì „ì²´ í‰ê· </div>
        </div>
        <div class="stat">
          <div class="k">í‰ê·  VPH</div>
          <div class="v" id="avgVph">-</div>
          <div class="s">ì‹œê°„ë‹¹ ì¡°íšŒ ë°˜ì‘ ì†ë„</div>
        </div>
        <div class="stat">
          <div class="k">í‰ê·  ì˜í–¥ë ¥</div>
          <div class="v" id="avgImpact">-</div>
          <div class="s">êµ¬ë…ì ëŒ€ë¹„ ì¡°íšŒìˆ˜(%)</div>
        </div>
        <div class="stat">
          <div class="k">ìˆí¼/ë¡±í¼ ë¹„ìœ¨</div>
          <div class="v" id="ratioSL">-</div>
          <div class="s">ìˆí¼(1ë¶„ ë¯¸ë§Œ) / ë¡±í¼(20ë¶„ ì´ìƒ)</div>
        </div>

        <div class="stat wide">
          <div class="k">ê°€ì¥ ë§ì´ ì“°ì¸ íƒœê·¸ TOP 5</div>
          <div class="taglist" id="topTags">
            <span class="muted">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ í‘œì‹œë©ë‹ˆë‹¤.</span>
          </div>
          <div class="s">íƒœê·¸ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ íƒœê·¸ë¡œ ì¬ê²€ìƒ‰</div>
        </div>

        <div class="stat wide">
          <div class="k">í˜„ì¬ ê²€ìƒ‰ì–´</div>
          <div class="v" id="currentQuery" style="font-size:18px;font-weight:820;line-height:1.2;">-</div>
          <div class="s muted" id="summaryLine">-</div>
        </div>
      </div>

      <!-- ì—°ê´€ í‚¤ì›Œë“œ -->
      <div class="kw-wrap">
        <div class="kw-head">
          <div>
            <div class="kw-title">ì—°ê´€ í‚¤ì›Œë“œ ë¶„ì„</div>
            <div class="kw-sub">ì œëª©/ì„¤ëª…/íƒœê·¸ì—ì„œ ë°˜ë³µ ë“±ì¥ ë‹¨ì–´ë¥¼ ì§‘ê³„(ë¶ˆìš©ì–´ ì œê±°, ì¡°íšŒìˆ˜ ê°€ì¤‘ì¹˜ ë°˜ì˜)</div>
          </div>
          <button class="btn small secondary" id="recalcKwBtn">ì—°ê´€ í‚¤ì›Œë“œ ë‹¤ì‹œ ê³„ì‚°</button>
        </div>
        <div class="taglist" id="relatedKeywords">
          <span class="muted">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ í‘œì‹œë©ë‹ˆë‹¤.</span>
        </div>
      </div>

      <!-- í…Œì´ë¸” -->
      <div class="table-card">
        <div class="table-toolbar">
          <div class="left">
            <span class="badge" id="resultCount">ê²°ê³¼ 0ê°œ</span>
            <span class="badge" id="activeFilters">í•„í„°: ì—†ìŒ</span>
          </div>
          <div class="right">
            <button class="btn small secondary" id="csvBtn2">CSV ë‹¤ìš´ë¡œë“œ</button>
          </div>
        </div>

        <div class="table-wrap">
          <table id="resultTable">
            <thead>
              <tr>
                <th data-key="thumbnail">ì¸ë„¤ì¼</th>
                <th data-key="title">ì œëª©<span class="sort" id="sort_title"></span></th>
                <th data-key="description">ì„¤ëª…</th>
                <th data-key="tags">íƒœê·¸</th>
                <th data-key="views">ì¡°íšŒìˆ˜<span class="sort" id="sort_views"></span></th>
                <th data-key="likes">ì¢‹ì•„ìš”<span class="sort" id="sort_likes"></span></th>
                <th data-key="subscribers">êµ¬ë…ììˆ˜<span class="sort" id="sort_subscribers"></span></th>
                <th data-key="vph">VPH<span class="sort" id="sort_vph"></span></th>
                <th data-key="impact">ì˜í–¥ë ¥(%)<span class="sort" id="sort_impact"></span></th>
                <th data-key="performance">ì„±ê³¼</th>
                <th data-key="publishedAt">ì—…ë¡œë“œ<span class="sort" id="sort_publishedAt"></span></th>
                <th data-key="durationSec">ê¸¸ì´<span class="sort" id="sort_durationSec"></span></th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr>
                <td colspan="12" class="muted" style="padding:16px;">
                  ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢Œì¸¡ì—ì„œ API í‚¤ë¥¼ ì €ì¥í•˜ê³  ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ì„¸ìš”.
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="hint" style="margin-top:12px;">
        â€» â€˜ì„±ê³¼â€™ëŠ” <span class="mono">(ì¡°íšŒìˆ˜ Ã· êµ¬ë…ììˆ˜)Ã—100</span> ê¸°ë°˜ ì˜í–¥ë ¥ ë“±ê¸‰ì„ ìƒ‰ìƒìœ¼ë¡œ í‘œì‹œí•œ ê°’ì…ë‹ˆë‹¤.
      </div>
    </main>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div class="toast" id="toast">
    <button class="x" id="toastClose">âœ•</button>
    <div class="t" id="toastTitle">ì•Œë¦¼</div>
    <div class="d" id="toastDesc">-</div>
  </div>

  <script>
    /***********************
     * ìœ í‹¸
     ***********************/
    const $ = (id) => document.getElementById(id);

    function showToast(title, desc){
      $("toastTitle").textContent = title;
      $("toastDesc").textContent = desc;
      $("toast").classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> $("toast").classList.remove("show"), 4200);
    }
    $("toastClose").addEventListener("click", ()=> $("toast").classList.remove("show"));

    function num(n){
      const x = Number(n);
      if (!Number.isFinite(x)) return 0;
      return x;
    }
    function fmtInt(n){
      const x = Math.round(num(n));
      return x.toLocaleString("ko-KR");
    }
    function fmtFloat(n, d=2){
      const x = num(n);
      return x.toLocaleString("ko-KR",{minimumFractionDigits:d, maximumFractionDigits:d});
    }
    function daysAgoISO(iso){
      const t = Date.parse(iso);
      if (!Number.isFinite(t)) return null;
      const diff = Date.now() - t;
      return diff / (1000*60*60*24);
    }

    // ISO8601 duration(PT#H#M#S) -> seconds
    function parseDurationToSec(iso){
      if (!iso || typeof iso !== "string") return 0;
      const m = iso.match(/^PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?$/);
      if (!m) return 0;
      const h = num(m[1]);
      const mi = num(m[2]);
      const s = num(m[3]);
      return (h*3600)+(mi*60)+s;
    }
    function formatDuration(sec){
      sec = Math.max(0, Math.floor(num(sec)));
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      if (h>0) return `${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;
      if (m>0) return `${m}ë¶„ ${s}ì´ˆ`;
      return `${s}ì´ˆ`;
    }

    // CSV (UTF-8 BOM í¬í•¨)
    function toCSV(rows, headers){
      const BOM = "\uFEFF";
      const esc = (v) => {
        const s = (v ?? "").toString().replace(/\r?\n/g, " ").trim();
        if (/[",]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
        return s;
      };
      const headLine = headers.map(h => esc(h.label)).join(",");
      const lines = rows.map(r => headers.map(h => esc(r[h.key])).join(","));
      return BOM + [headLine, ...lines].join("\n");
    }
    function downloadTextFile(filename, text){
      const blob = new Blob([text], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ(ì‹œë„)
    async function downloadImage(url, filename){
      try{
        const res = await fetch(url, {mode:"cors"});
        const blob = await res.blob();
        const obj = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = obj;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(obj);
      }catch(e){
        // CORSë¡œ ë§‰íˆë©´ ìƒˆ íƒ­ ì—´ê¸° ëŒ€ì²´
        window.open(url, "_blank");
        showToast("ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ", "ì¼ë¶€ ì¸ë„¤ì¼ì€ ë¸Œë¼ìš°ì € ì •ì±…(CORS)ìœ¼ë¡œ ì§ì ‘ ë‹¤ìš´ë¡œë“œê°€ ì œí•œë  ìˆ˜ ìˆì–´ ìƒˆ íƒ­ìœ¼ë¡œ ì—´ì—ˆìŠµë‹ˆë‹¤.");
      }
    }

    /***********************
     * ì„±ê³¼(ì˜í–¥ë ¥) ë“±ê¸‰
     * - ì˜í–¥ë ¥(%) = (ì¡°íšŒìˆ˜ / êµ¬ë…ììˆ˜) * 100
     * - 5ë‹¨ê³„: ë¹¨ê°•-ì£¼í™©-ë…¸ë‘-ì´ˆë¡-íŒŒë‘ (ë†’ì€ ìˆœ)
     ***********************/
    function impactPercent(views, subs){
      views = num(views);
      subs = num(subs);
      if (subs <= 0) return null;
      return (views / subs) * 100;
    }

    // ê¸°ì¤€ì€ ì„ì˜(í˜„ì‹¤ì—ì„œ ì¡°ì • ê°€ëŠ¥)
    function impactLevel(impact){
      if (impact == null || !Number.isFinite(impact)) return {level: 1, label:"ë§¤ìš° ë‚®ìŒ", color:"#3aa0ff"}; // íŒŒë‘
      if (impact >= 300) return {level: 5, label:"ë§¤ìš° ë†’ìŒ", color:"#ff4d4d"}; // ë¹¨ê°•
      if (impact >= 150) return {level: 4, label:"ë†’ìŒ", color:"#ff8a00"}; // ì£¼í™©
      if (impact >= 70)  return {level: 3, label:"ë³´í†µ", color:"#ffcc00"}; // ë…¸ë‘
      if (impact >= 25)  return {level: 2, label:"ë‚®ìŒ", color:"#1ed760"}; // ì´ˆë¡
      return {level: 1, label:"ë§¤ìš° ë‚®ìŒ", color:"#3aa0ff"}; // íŒŒë‘
    }

    /***********************
     * ìƒíƒœ ë°ì´í„°
     ***********************/
    let rawVideos = [];      // ì „ì²´ ê²°ê³¼(ê°€ê³µëœ í˜•íƒœ)
    let viewVideos = [];     // í•„í„°/ì •ë ¬ ì ìš© ê²°ê³¼
    let currentSort = { key: "views", dir: "desc" }; // ì²« í™”ë©´ ì¡°íšŒìˆ˜ ë†’ì€ ìˆœ

    /***********************
     * API í‚¤ ì €ì¥/ë¡œë“œ
     ***********************/
    function loadApiKey(){
      const k = localStorage.getItem("YT_API_KEY") || "";
      $("apiKey").value = k;
      return k;
    }
    function saveApiKey(){
      const k = $("apiKey").value.trim();
      if (!k){
        showToast("API í‚¤", "API í‚¤ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
        return;
      }
      localStorage.setItem("YT_API_KEY", k);
      showToast("API í‚¤ ì €ì¥", "API í‚¤ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    function clearApiKey(){
      localStorage.removeItem("YT_API_KEY");
      $("apiKey").value = "";
      showToast("API í‚¤ ì‚­ì œ", "ì €ì¥ëœ API í‚¤ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
    }

    $("saveKeyBtn").addEventListener("click", saveApiKey);
    $("clearKeyBtn").addEventListener("click", clearApiKey);

    /***********************
     * YouTube API í˜¸ì¶œ
     ***********************/
    async function ytFetch(url){
      const res = await fetch(url);
      const data = await res.json().catch(()=> ({}));
      if (!res.ok){
        const msg = data?.error?.message || "ìš”ì²­ ì‹¤íŒ¨";
        throw new Error(msg);
      }
      return data;
    }

    // 1) search.list (ì¡°íšŒìˆ˜ ê¸°ì¤€ ì •ë ¬)
    async function searchVideosByTitle(apiKey, q, maxResults){
      const params = new URLSearchParams({
        key: apiKey,
        part: "snippet",
        q: q,
        type: "video",
        maxResults: String(maxResults),
        order: "viewCount" // ì²« í™”ë©´ ì¡°íšŒìˆ˜ ë†’ì€ ìˆœ
      });
      const url = "https://www.googleapis.com/youtube/v3/search?" + params.toString();
      const data = await ytFetch(url);
      const items = Array.isArray(data.items) ? data.items : [];
      const videoIds = items.map(it => it?.id?.videoId).filter(Boolean);
      return videoIds;
    }

    // 2) videos.list (ìŠ¤íƒ¯/íƒœê·¸/ê¸¸ì´ ë“±)
    async function fetchVideoDetails(apiKey, ids){
      if (!ids.length) return [];
      const params = new URLSearchParams({
        key: apiKey,
        part: "snippet,statistics,contentDetails",
        id: ids.join(","),
        maxResults: "50"
      });
      const url = "https://www.googleapis.com/youtube/v3/videos?" + params.toString();
      const data = await ytFetch(url);
      return Array.isArray(data.items) ? data.items : [];
    }

    // 3) channels.list (êµ¬ë…ììˆ˜)
    async function fetchChannelStats(apiKey, channelIds){
      const uniq = Array.from(new Set(channelIds.filter(Boolean)));
      if (!uniq.length) return {};
      const params = new URLSearchParams({
        key: apiKey,
        part: "statistics",
        id: uniq.join(","),
        maxResults: "50"
      });
      const url = "https://www.googleapis.com/youtube/v3/channels?" + params.toString();
      const data = await ytFetch(url);
      const items = Array.isArray(data.items) ? data.items : [];
      const map = {};
      for (const it of items){
        const id = it?.id;
        const subs = num(it?.statistics?.subscriberCount);
        map[id] = subs;
      }
      return map;
    }

    /***********************
     * ë°ì´í„° ê°€ê³µ
     ***********************/
    function buildVideoObjects(videoItems, channelSubsMap){
      const now = Date.now();
      const out = [];
      for (const v of videoItems){
        const id = v?.id;
        const sn = v?.snippet || {};
        const st = v?.statistics || {};
        const cd = v?.contentDetails || {};
        const title = sn?.title || "";
        const description = sn?.description || "";
        const publishedAt = sn?.publishedAt || "";
        const channelId = sn?.channelId || "";
        const channelTitle = sn?.channelTitle || "";
        const tagsArr = Array.isArray(sn?.tags) ? sn.tags : [];
        const tags = tagsArr.length ? tagsArr.join(", ") : "íƒœê·¸ ì—†ìŒ";

        const views = num(st?.viewCount);
        const likes = num(st?.likeCount);
        const durationSec = parseDurationToSec(cd?.duration);
        const subscribers = num(channelSubsMap[channelId]);

        // VPH = ì¡°íšŒìˆ˜ / (ì—…ë¡œë“œ í›„ ì‹œê°„)
        let hours = 0;
        const p = Date.parse(publishedAt);
        if (Number.isFinite(p)){
          hours = (now - p) / (1000*60*60);
        }
        if (!Number.isFinite(hours) || hours <= 1) hours = 1; // 0 ë°©ì§€
        const vph = views / hours;

        const impact = impactPercent(views, subscribers);
        const perf = impactLevel(impact);

        // ì˜ìƒìœ í˜•(ìˆí¼/ë¡±í¼)
        const isShort = durationSec > 0 && durationSec < 60;
        const isLong  = durationSec >= 1200;

        // ì¸ë„¤ì¼
        const thumbs = sn?.thumbnails || {};
        const thumbUrl = thumbs?.medium?.url || thumbs?.default?.url || "";

        out.push({
          id,
          title,
          description,
          tags,
          tagsArr,
          views,
          likes,
          subscribers,
          vph,
          impact,
          performance: perf, // {level,label,color}
          publishedAt,
          durationSec,
          durationText: formatDuration(durationSec),
          isShort,
          isLong,
          channelTitle,
          channelId,
          thumbUrl
        });
      }
      return out;
    }

    /***********************
     * í•„í„°/ì •ë ¬
     ***********************/
    function getActiveFilterText(){
      const type = $("typeFilter").value;
      const datePreset = $("datePreset").value;
      const impact = $("impactFilter").value;

      const parts = [];
      if (type === "short") parts.push("ìˆí¼");
      else if (type === "long") parts.push("ë¡±í¼");

      if (datePreset !== "all"){
        if (datePreset === "custom"){
          const f = $("dateFrom").value || "ì‹œì‘ ë¯¸ì§€ì •";
          const t = $("dateTo").value || "ë ë¯¸ì§€ì •";
          parts.push(`ê¸°ê°„ ${f}~${t}`);
        }else{
          parts.push(`ìµœê·¼ ${datePreset}ì¼`);
        }
      }

      if (impact !== "all"){
        const map = { "5":"ğŸ”´", "4":"ğŸŸ ", "3":"ğŸŸ¡", "2":"ğŸŸ¢", "1":"ğŸ”µ" };
        parts.push(`ì˜í–¥ë ¥ ${map[impact] || ""}`);
      }
      return parts.length ? parts.join(" / ") : "ì—†ìŒ";
    }

    function applyFilters(){
      const type = $("typeFilter").value;
      const datePreset = $("datePreset").value;
      const impact = $("impactFilter").value;

      let fromDays = null;
      let customFrom = null;
      let customTo = null;

      if (datePreset === "7" || datePreset === "30" || datePreset === "90"){
        fromDays = num(datePreset);
      }else if (datePreset === "custom"){
        customFrom = $("dateFrom").value ? Date.parse($("dateFrom").value + "T00:00:00") : null;
        customTo   = $("dateTo").value ? Date.parse($("dateTo").value + "T23:59:59") : null;
      }

      viewVideos = rawVideos.filter(v=>{
        // ìœ í˜•
        if (type === "short" && !v.isShort) return false;
        if (type === "long" && !v.isLong) return false;

        // ë‚ ì§œ
        if (fromDays != null){
          const d = daysAgoISO(v.publishedAt);
          if (d == null) return false;
          if (d > fromDays) return false;
        }
        if (datePreset === "custom"){
          const p = Date.parse(v.publishedAt);
          if (!Number.isFinite(p)) return false;
          if (customFrom != null && p < customFrom) return false;
          if (customTo != null && p > customTo) return false;
        }

        // ì˜í–¥ë ¥
        if (impact !== "all"){
          const want = num(impact);
          if (v.performance.level !== want) return false;
        }

        return true;
      });

      // ì •ë ¬ ì ìš©
      sortBy(currentSort.key, currentSort.dir, true);

      $("activeFilters").textContent = "í•„í„°: " + getActiveFilterText();
      $("resultCount").textContent = `ê²°ê³¼ ${viewVideos.length}ê°œ`;
      renderDashboard(viewVideos);
      renderRelatedKeywords(viewVideos);
      renderTable(viewVideos);
    }

    function sortBy(key, dir, silent=false){
      currentSort = { key, dir };

      const getVal = (v) => {
        if (key === "title") return (v.title || "").toLowerCase();
        if (key === "publishedAt") return Date.parse(v.publishedAt) || 0;
        if (key === "durationSec") return num(v.durationSec);
        if (key === "thumbnail") return ""; // ì •ë ¬ ì—†ìŒ
        if (key === "description") return (v.description || "").toLowerCase();
        if (key === "tags") return (v.tags || "").toLowerCase();
        if (key === "performance") return num(v.performance?.level);
        // ìˆ«ì
        return num(v[key]);
      };

      viewVideos.sort((a,b)=>{
        const va = getVal(a);
        const vb = getVal(b);
        if (typeof va === "string" && typeof vb === "string"){
          if (va < vb) return dir==="asc" ? -1 : 1;
          if (va > vb) return dir==="asc" ? 1 : -1;
          return 0;
        }
        return dir==="asc" ? (va - vb) : (vb - va);
      });

      updateSortIndicators();
      if (!silent){
        renderTable(viewVideos);
      }
    }

    function updateSortIndicators(){
      // ëª¨ë“  í‘œì‹œ ì´ˆê¸°í™”
      const ids = ["title","views","likes","subscribers","vph","impact","publishedAt","durationSec"];
      for (const k of ids){
        const el = $("sort_"+k);
        if (el) el.textContent = "";
      }
      const el = $("sort_"+currentSort.key);
      if (el){
        el.textContent = currentSort.dir === "asc" ? "â–²" : "â–¼";
      }
    }

    /***********************
     * ë Œë”ë§
     ***********************/
    function renderTable(list){
      const tb = $("tbody");
      if (!list.length){
        tb.innerHTML = `<tr><td colspan="12" class="muted" style="padding:16px;">ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. í•„í„°ë¥¼ ì™„í™”í•´ ë³´ì„¸ìš”.</td></tr>`;
        return;
      }

      const rows = list.map(v=>{
        const watchUrl = `https://www.youtube.com/watch?v=${encodeURIComponent(v.id)}`;
        const impactText = (v.impact == null || !Number.isFinite(v.impact)) ? "-" : fmtFloat(v.impact,2);
        const perf = v.performance || impactLevel(null);

        const descShort = (v.description || "").slice(0, 120);
        const descMore = (v.description || "").length > 120 ? "â€¦" : "";

        const safeTitle = (v.title || "").replace(/"/g,"'");
        const fileSafe = safeTitle.replace(/[\\/:*?"<>|]/g," ").slice(0, 60).trim() || "thumbnail";

        return `
          <tr>
            <td>
              <img class="thumb" src="${v.thumbUrl}" alt="ì¸ë„¤ì¼" title="í´ë¦­í•˜ë©´ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œë„í•©ë‹ˆë‹¤."
                data-thumb="${v.thumbUrl}" data-fn="${fileSafe}.jpg"/>
            </td>
            <td style="min-width:260px;">
              <a href="${watchUrl}" target="_blank" rel="noopener">${escapeHtml(v.title)}</a>
              <div class="muted" style="margin-top:4px;">${escapeHtml(v.channelTitle || "")}</div>
            </td>
            <td style="min-width:320px; max-width:360px;">
              ${escapeHtml(descShort)}${descMore}
            </td>
            <td style="min-width:260px;">
              <div class="tags-cell" title="${escapeHtml(v.tags)}">${escapeHtml(v.tags)}</div>
            </td>
            <td class="mono">${fmtInt(v.views)}</td>
            <td class="mono">${fmtInt(v.likes)}</td>
            <td class="mono">${fmtInt(v.subscribers)}</td>
            <td class="mono">${fmtFloat(v.vph,2)}</td>
            <td class="mono">${impactText}</td>
            <td>
              <span class="perf" title="êµ¬ë…ì ëŒ€ë¹„ ì¡°íšŒìˆ˜ ì˜í–¥ë ¥ ë“±ê¸‰">
                <span class="dot" style="background:${perf.color};"></span>
                <span>${perf.label}</span>
              </span>
            </td>
            <td class="mono">${formatDateKR(v.publishedAt)}</td>
            <td class="mono">${escapeHtml(v.durationText)}</td>
          </tr>
        `;
      }).join("");

      tb.innerHTML = rows;

      // ì¸ë„¤ì¼ ë‹¤ìš´ë¡œë“œ ì´ë²¤íŠ¸
      tb.querySelectorAll("img.thumb").forEach(img=>{
        img.addEventListener("click", async ()=>{
          const url = img.getAttribute("data-thumb");
          const fn  = img.getAttribute("data-fn");
          if (url) await downloadImage(url, fn || "thumbnail.jpg");
        });
      });
    }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function formatDateKR(iso){
      const t = Date.parse(iso);
      if (!Number.isFinite(t)) return "-";
      const d = new Date(t);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function renderDashboard(list){
      if (!list.length){
        $("avgViews").textContent = "-";
        $("avgVph").textContent = "-";
        $("avgImpact").textContent = "-";
        $("ratioSL").textContent = "-";
        $("topTags").innerHTML = `<span class="muted">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ í‘œì‹œë©ë‹ˆë‹¤.</span>`;
        $("summaryLine").textContent = "-";
        return;
      }

      const avgViews = list.reduce((a,v)=>a+num(v.views),0) / list.length;
      const avgVph   = list.reduce((a,v)=>a+num(v.vph),0) / list.length;

      const impacts = list.map(v=>v.impact).filter(x=>x!=null && Number.isFinite(x));
      const avgImpact = impacts.length ? (impacts.reduce((a,x)=>a+num(x),0)/impacts.length) : null;

      const shortCnt = list.filter(v=>v.isShort).length;
      const longCnt  = list.filter(v=>v.isLong).length;

      $("avgViews").textContent = fmtInt(avgViews);
      $("avgVph").textContent = fmtFloat(avgVph,2);
      $("avgImpact").textContent = (avgImpact==null ? "-" : fmtFloat(avgImpact,2));
      $("ratioSL").textContent = `${shortCnt} / ${longCnt}`;

      // íƒœê·¸ TOP5
      const tagFreq = new Map();
      for (const v of list){
        const arr = Array.isArray(v.tagsArr) ? v.tagsArr : [];
        for (const t of arr){
          const key = (t || "").trim();
          if (!key) continue;
          tagFreq.set(key, (tagFreq.get(key) || 0) + 1);
        }
      }
      const top = Array.from(tagFreq.entries())
        .sort((a,b)=> b[1]-a[1])
        .slice(0,5);

      if (!top.length){
        $("topTags").innerHTML = `<span class="muted">íƒœê·¸ê°€ ì—†ëŠ” ì˜ìƒì´ ë§ì•„ TOP 5ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`;
      }else{
        $("topTags").innerHTML = top.map(([tag,c])=>{
          return `<span class="chip" data-tag="${escapeHtml(tag)}"><span>#${escapeHtml(tag)}</span><span class="count">(${c})</span></span>`;
        }).join("");

        $("topTags").querySelectorAll(".chip").forEach(ch=>{
          ch.addEventListener("click", ()=>{
            const tag = ch.getAttribute("data-tag") || "";
            if (!tag) return;
            // íƒœê·¸ í´ë¦­ â†’ ê²€ìƒ‰ì–´ë¡œ ì¬ê²€ìƒ‰
            $("query").value = tag;
            $("searchBtn").click();
          });
        });
      }

      // ìš”ì•½ ë¬¸ì¥
      const bestByViews = list.slice().sort((a,b)=>b.views-a.views)[0];
      const bestByVph   = list.slice().sort((a,b)=>b.vph-a.vph)[0];
      $("summaryLine").textContent =
        `ìµœê³  ì¡°íšŒìˆ˜: ${bestByViews ? bestByViews.title.slice(0,40) : "-"} / ` +
        `ìµœê³  VPH: ${bestByVph ? bestByVph.title.slice(0,40) : "-"}`;
    }

    /***********************
     * ì—°ê´€ í‚¤ì›Œë“œ ë¶„ì„
     ***********************/
    const STOPWORDS = new Set([
      "ê·¸","ì´","ì €","ê²ƒ","ìˆ˜","ë“±","ë°","ë˜ëŠ”","ê·¸ë¦¬ê³ ","í•˜ì§€ë§Œ","ê·¸ë˜ì„œ","ë•Œë¬¸","ì •ë§","ë„ˆë¬´","ì§„ì§œ",
      "í•©ë‹ˆë‹¤","í•˜ëŠ”","í•˜ê¸°","í•œ","í–ˆë‹¤","ëœë‹¤","ë˜ë‹¤","ìˆëŠ”","ìˆë‹¤","ì—†ë‹¤","ê°™ì€","ëŒ€í•œ","ê´€ë ¨","ë°©ë²•",
      "ì˜ìƒ","ìœ íŠœë¸Œ","ì¡°íšŒìˆ˜","ì¢‹ì•„ìš”","êµ¬ë…","êµ¬ë…ì","ì±„ë„","shorts","short","ì‡¼ì¸ ","ë¡±í¼","long",
      "ì˜¤ëŠ˜","ë‚´ì¼","ì–´ì œ","ì´ë²ˆ","ìµœê·¼","ìµœì‹ ","ëª¨ìŒ","ì •ë¦¬","ì¶”ì²œ","ë¦¬ë·°","í›„ê¸°","ì™„ë²½","ì´ˆë³´","ì…ë¬¸",
      "the","a","an","and","or","to","of","in","on","is","are","with","for"
    ]);

    function tokenize(text){
      // í•œê¸€/ì˜ë¬¸/ìˆ«ìë§Œ ë‚¨ê¸°ê³  ë¶„ë¦¬
      const cleaned = (text || "")
        .toString()
        .toLowerCase()
        .replace(/[\u0000-\u001F]/g," ")
        .replace(/[^\p{L}\p{N}\s]/gu, " ")
        .replace(/\s+/g," ")
        .trim();
      if (!cleaned) return [];
      const tokens = cleaned.split(" ")
        .map(t=>t.trim())
        .filter(Boolean)
        .filter(t => t.length >= 2 && t.length <= 20)
        .filter(t => !STOPWORDS.has(t));
      return tokens;
    }

    function buildRelatedKeywords(list, topN=20){
      const freq = new Map();

      // ì¡°íšŒìˆ˜ ê°€ì¤‘ì¹˜: log(views+1)
      for (const v of list){
        const w = Math.log10(num(v.views) + 1) + 1;
        const combined = [
          v.title || "",
          v.description || "",
          (Array.isArray(v.tagsArr) ? v.tagsArr.join(" ") : "")
        ].join(" ");
        const tokens = tokenize(combined);

        // í•œ ì˜ìƒ ì•ˆì—ì„œ ê°™ì€ ë‹¨ì–´ ì¤‘ë³µ ê°€ì¤‘ì¹˜ ë°©ì§€
        const uniq = new Set(tokens);
        for (const t of uniq){
          freq.set(t, (freq.get(t) || 0) + w);
        }
      }

      return Array.from(freq.entries())
        .sort((a,b)=> b[1]-a[1])
        .slice(0, topN)
        .map(([k,score])=>({k, score}));
    }

    function renderRelatedKeywords(list){
      const box = $("relatedKeywords");
      if (!list.length){
        box.innerHTML = `<span class="muted">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ í‘œì‹œë©ë‹ˆë‹¤.</span>`;
        return;
      }
      const kws = buildRelatedKeywords(list, 24);
      if (!kws.length){
        box.innerHTML = `<span class="muted">ì—°ê´€ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`;
        return;
      }
      box.innerHTML = kws.map(x=>{
        const score = fmtFloat(x.score,2);
        return `<span class="chip" data-kw="${escapeHtml(x.k)}"><span>${escapeHtml(x.k)}</span><span class="count">(${score})</span></span>`;
      }).join("");

      box.querySelectorAll(".chip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          const kw = ch.getAttribute("data-kw") || "";
          if (!kw) return;
          $("query").value = kw;
          $("searchBtn").click();
        });
      });
    }

    $("recalcKwBtn").addEventListener("click", ()=>{
      renderRelatedKeywords(viewVideos);
      showToast("ì—°ê´€ í‚¤ì›Œë“œ", "í˜„ì¬ ê²°ê³¼ ê¸°ì¤€ìœ¼ë¡œ ì—°ê´€ í‚¤ì›Œë“œë¥¼ ë‹¤ì‹œ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.");
    });

    /***********************
     * CSV ë‹¤ìš´ë¡œë“œ
     ***********************/
    function exportCSV(){
      if (!viewVideos.length){
        showToast("CSV ë‹¤ìš´ë¡œë“œ", "ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      const headers = [
        {label:"ì˜ìƒID", key:"id"},
        {label:"ì œëª©", key:"title"},
        {label:"ì„¤ëª…", key:"description"},
        {label:"íƒœê·¸", key:"tags"},
        {label:"ì¡°íšŒìˆ˜", key:"views"},
        {label:"ì¢‹ì•„ìš”ìˆ˜", key:"likes"},
        {label:"êµ¬ë…ììˆ˜", key:"subscribers"},
        {label:"VPH", key:"vph"},
        {label:"ì˜í–¥ë ¥(%)", key:"impact"},
        {label:"ì„±ê³¼", key:"performanceLabel"},
        {label:"ì—…ë¡œë“œë‚ ì§œ", key:"publishedAt"},
        {label:"ì˜ìƒê¸¸ì´(ì´ˆ)", key:"durationSec"},
        {label:"ì˜ìƒê¸¸ì´(í‘œì‹œ)", key:"durationText"},
        {label:"ì¸ë„¤ì¼", key:"thumbUrl"},
        {label:"ì˜ìƒë§í¬", key:"watchUrl"}
      ];

      const rows = viewVideos.map(v=>{
        return {
          id: v.id,
          title: v.title,
          description: v.description,
          tags: v.tags,
          views: v.views,
          likes: v.likes,
          subscribers: v.subscribers,
          vph: Number.isFinite(v.vph) ? v.vph.toFixed(2) : "",
          impact: (v.impact==null || !Number.isFinite(v.impact)) ? "" : v.impact.toFixed(2),
          performanceLabel: v.performance?.label || "",
          publishedAt: formatDateKR(v.publishedAt),
          durationSec: v.durationSec,
          durationText: v.durationText,
          thumbUrl: v.thumbUrl,
          watchUrl: `https://www.youtube.com/watch?v=${v.id}`
        };
      });

      const csv = toCSV(rows, headers);
      const q = ($("query").value || "ê²€ìƒ‰ê²°ê³¼").trim().slice(0,40).replace(/[\\/:*?"<>|]/g," ");
      const filename = `ìœ íŠœë¸Œ_ë¶„ì„_${q}_${new Date().toISOString().slice(0,10)}.csv`;
      downloadTextFile(filename, csv);
      showToast("CSV ë‹¤ìš´ë¡œë“œ", "CSV íŒŒì¼ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.");
    }

    $("csvBtn").addEventListener("click", exportCSV);
    $("csvBtn2").addEventListener("click", exportCSV);

    /***********************
     * ì´ë²¤íŠ¸: ë‚ ì§œ í”„ë¦¬ì…‹
     ***********************/
    $("datePreset").addEventListener("change", ()=>{
      const v = $("datePreset").value;
      $("customDateRow").style.display = (v === "custom") ? "flex" : "none";
    });

    $("applyFilterBtn").addEventListener("click", ()=>{
      applyFilters();
      showToast("í•„í„° ì ìš©", "í•„í„°/ì •ë ¬ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    $("resetBtn").addEventListener("click", ()=>{
      rawVideos = [];
      viewVideos = [];
      currentSort = { key: "views", dir: "desc" };
      $("query").value = "";
      $("typeFilter").value = "all";
      $("datePreset").value = "all";
      $("customDateRow").style.display = "none";
      $("impactFilter").value = "all";
      $("resultCount").textContent = "ê²°ê³¼ 0ê°œ";
      $("activeFilters").textContent = "í•„í„°: ì—†ìŒ";
      $("currentQuery").textContent = "-";
      $("tbody").innerHTML = `<tr><td colspan="12" class="muted" style="padding:16px;">ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì¢Œì¸¡ì—ì„œ API í‚¤ë¥¼ ì €ì¥í•˜ê³  ê²€ìƒ‰ì„ ì‹¤í–‰í•˜ì„¸ìš”.</td></tr>`;
      renderDashboard([]);
      $("relatedKeywords").innerHTML = `<span class="muted">ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ í‘œì‹œë©ë‹ˆë‹¤.</span>`;
      updateSortIndicators();
      showToast("ì´ˆê¸°í™”", "í™”ë©´ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
    });

    /***********************
     * í…Œì´ë¸” ì •ë ¬ í—¤ë” í´ë¦­
     ***********************/
    $("resultTable").querySelectorAll("th[data-key]").forEach(th=>{
      th.addEventListener("click", ()=>{
        const key = th.getAttribute("data-key");
        if (!key) return;
        // ì¸ë„¤ì¼/ì„¤ëª…ì€ ì •ë ¬ ì˜ë¯¸ê°€ ì•½í•˜ë¯€ë¡œ í—ˆìš©ì€ í•˜ë˜ ê¸°ë³¸ ì²˜ë¦¬
        let dir = "desc";
        if (currentSort.key === key){
          dir = currentSort.dir === "desc" ? "asc" : "desc";
        }else{
          // ìˆ«ìëŠ” desc ê¸°ë³¸, ë¬¸ìì—´ì€ asc ê¸°ë³¸
          if (["title","description","tags"].includes(key)) dir = "asc";
          else dir = "desc";
        }
        sortBy(key, dir);
      });
    });

    /***********************
     * ê²€ìƒ‰ ì‹¤í–‰
     ***********************/
    $("searchBtn").addEventListener("click", async ()=>{
      const apiKey = ($("apiKey").value || "").trim() || (localStorage.getItem("YT_API_KEY") || "").trim();
      if (!apiKey){
        showToast("API í‚¤ í•„ìš”", "ì¢Œì¸¡ì— ìœ íŠœë¸Œ API í‚¤ë¥¼ ì…ë ¥í•˜ê³  â€˜í‚¤ ì €ì¥â€™ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        return;
      }

      const q = ($("query").value || "").trim();
      if (!q){
        showToast("ê²€ìƒ‰ì–´ í•„ìš”", "ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const maxResults = num($("maxResults").value) || 25;

      $("currentQuery").textContent = q;
      $("summaryLine").textContent = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦";

      // ë¡œë”© í‘œì‹œ
      $("tbody").innerHTML = `<tr><td colspan="12" class="muted" style="padding:16px;">ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤â€¦ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</td></tr>`;
      $("resultCount").textContent = "ê²°ê³¼ 0ê°œ";
      $("activeFilters").textContent = "í•„í„°: " + getActiveFilterText();
      renderDashboard([]);
      $("relatedKeywords").innerHTML = `<span class="muted">ì—°ê´€ í‚¤ì›Œë“œë¥¼ ê³„ì‚° ì¤‘â€¦</span>`;

      try{
        showToast("ê²€ìƒ‰ ì‹œì‘", "ìœ íŠœë¸Œ APIì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.");

        // 1) search.list
        const ids = await searchVideosByTitle(apiKey, q, maxResults);
        if (!ids.length){
          rawVideos = [];
          applyFilters();
          showToast("ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ", "í•´ë‹¹ ê²€ìƒ‰ì–´ë¡œ ì˜ìƒ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        // 2) videos.list
        const videoItems = await fetchVideoDetails(apiKey, ids);

        // 3) channels.list
        const channelIds = videoItems.map(v => v?.snippet?.channelId).filter(Boolean);
        const subsMap = await fetchChannelStats(apiKey, channelIds);

        // 4) ê°€ê³µ
        rawVideos = buildVideoObjects(videoItems, subsMap);

        // ê¸°ë³¸ ì •ë ¬(ì¡°íšŒìˆ˜)
        rawVideos.sort((a,b)=> b.views - a.views);
        viewVideos = rawVideos.slice();

        // í•„í„°/ì •ë ¬ ë°˜ì˜
        applyFilters();

        showToast("ì™„ë£Œ", `ì´ ${rawVideos.length}ê°œ ì˜ìƒì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
      }catch(e){
        const msg = (e && e.message) ? e.message : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜";
        $("tbody").innerHTML = `<tr><td colspan="12" class="muted" style="padding:16px;">ì˜¤ë¥˜: ${escapeHtml(msg)}<br/>API í‚¤ ê¶Œí•œ/í• ë‹¹ëŸ‰, ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.</td></tr>`;
        $("summaryLine").textContent = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        showToast("ì˜¤ë¥˜", msg);
      }
    });

    /***********************
     * ì´ˆê¸° ë¡œë“œ
     ***********************/
    loadApiKey();
    updateSortIndicators();

    // Enter í‚¤ë¡œ ê²€ìƒ‰
    $("query").addEventListener("keydown", (e)=>{
      if (e.key === "Enter") $("searchBtn").click();
    });
  </script>
</body>
</html>
